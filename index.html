<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SHAM â€“ auto-load repo data</title>

  <!-- =====  same CDN block as before  ===== -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script src="https://unpkg.com/three@0.150.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.150.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{--primary:#3b82f6;--dark:#0f172a;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);overflow:hidden;}
    .glass{background:rgba(30,41,59,.8);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.1);}
    .glass-dark{background:rgba(15,23,42,.9);backdrop-filter:blur(30px);border:1px solid rgba(255,255,255,.05);}
    .loader{width:40px;height:40px;border:3px solid rgba(59,130,246,.2);border-top-color:#3b82f6;border-radius:50%;animation:spin .8s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .three-canvas{position:absolute;top:0;left:0;width:100%;height:100%;z-index:15;}
    .custom-scroll{scrollbar-width:thin;scrollbar-color:#475569 #1e293b;}
    .custom-scroll::-webkit-scrollbar{width:6px;}
    .custom-scroll::-webkit-scrollbar-track{background:#1e293b;}
    .custom-scroll::-webkit-scrollbar-thumb{background:#475569;border-radius:3px;}
    .leaflet-control{background:rgba(15,23,42,.9)!important;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1)!important;border-radius:8px;color:#fff!important;}
    .leaflet-control-zoom a{background:transparent!important;color:#fff!important;}
    .leaflet-draw-toolbar a{background:rgba(30,41,59,.8)!important;color:#fff!important;}
    .error-boundary{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:.5rem;padding:1rem;margin:1rem 0;}
  </style>
</head>
<body class="h-full text-gray-100">

<div x-data="shamApp()" x-init="init()">
  <!-- =====  UI identical to previous file  ===== -->
  <main class="flex-1 relative overflow-hidden">
    <div id="map" class="h-full w-full"></div>
    <canvas id="three-canvas" class="three-canvas" x-show="viewMode==='3d'" style="display:none"></canvas>

    <div class="absolute top-4 left-4 z-30 space-y-2">
      <div class="glass rounded-lg p-1 flex gap-1">
        <button @click="setView('2d')" :class="{'bg-blue-600':viewMode==='2d'}" class="px-3 py-2 rounded text-sm font-medium transition"><i class="fas fa-map"></i> 2D</button>
        <button @click="setView('3d')" :class="{'bg-blue-600':viewMode==='3d'}" class="px-3 py-2 rounded text-sm font-medium transition"><i class="fas fa-cube"></i> 3D</button>
      </div>
      <div class="glass rounded-lg p-2 flex gap-2">
        <button @click="activateTool('marker')" :class="{'text-blue-400':activeTool==='marker'}" class="p-2 hover:bg-white/10 rounded transition" title="Add Marker"><i class="fas fa-map-pin"></i></button>
        <button @click="screenshot()" class="p-2 hover:bg-white/10 rounded transition" title="Screenshot"><i class="fas fa-camera"></i></button>
      </div>
    </div>

    <div class="absolute top-4 right-4 z-30 glass rounded-lg p-4 max-w-xs" x-show="showStats">
      <h3 class="text-sm font-semibold mb-2 flex items-center gap-2"><i class="fas fa-chart-bar text-blue-400"></i> Statistics</h3>
      <div class="grid grid-cols-2 gap-3 text-xs">
        <div><p class="text-gray-400">Features</p><p class="text-xl font-bold" x-text="stats.totalFeatures">0</p></div>
        <div><p class="text-gray-400">Layers</p><p class="text-xl font-bold" x-text="stats.activeLayers">0</p></div>
      </div>
    </div>

    <div class="absolute bottom-4 left-4 z-30 glass rounded-lg px-3 py-2 text-xs font-mono">
      Lat: <span x-text="coordinates.lat">0.0000</span>, Lng: <span x-text="coordinates.lng">0.0000</span> | Zoom: <span x-text="coordinates.zoom">10</span>
</div>

<script>
  function shamApp() {
    return {
      map: null,
      viewMode: '2d',
      activeTool: null,
      showStats: true,
      stats: {
        totalFeatures: 0,
        activeLayers: 0,
      },
      coordinates: {
        lat: 0,
        lng: 0,
        zoom: 10,
      },

      init() {
        this.map = L.map('map').setView([26.8206, 30.8025], 6); // Centered on Egypt

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
          subdomains: 'abcd',
          maxZoom: 20
        }).addTo(this.map);

        this.map.on('mousemove', (e) => {
          this.coordinates.lat = e.latlng.lat.toFixed(4);
          this.coordinates.lng = e.latlng.lng.toFixed(4);
        });

        this.map.on('zoomend', () => {
          this.coordinates.zoom = this.map.getZoom();
        });

        this.loadSites();
      },

      loadSites() {
        fetch('SHAM-repo/sham_local_data/maps/egypt_sites.geojson')
          .then(response => response.json())
          .then(data => {
            const sitesLayer = L.geoJSON(data, {
              onEachFeature: (feature, layer) => {
                let popupContent = `<strong>${feature.properties.name}</strong><br>`;
                for (const prop in feature.properties) {
                  if (prop !== 'name') {
                    popupContent += `<strong>${prop}:</strong> ${feature.properties[prop]}<br>`;
                  }
                }
                layer.bindPopup(popupContent);
              }
            }).addTo(this.map);

            this.stats.totalFeatures = data.features.length;
            this.stats.activeLayers = 1;
          });
      },

      setView(mode) {
        this.viewMode = mode;
      },

      activateTool(tool) {
        this.activeTool = this.activeTool === tool ? null : tool;
      },

      screenshot() {
        alert('Screenshot functionality not implemented yet.');
      },
    };
  }
</script>

</body>
</html>
